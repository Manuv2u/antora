
= Integrating AWS Secrets Manager with Amazon EKS

== Setting up the infrastructure for Secrets Manager with Amazon EKS integration



ASCP for Kubernetes Secrets Store CSI Driver

The AWS Secrets and Configuration Provider (ASCP) for the Kubernetes Secrets Store CSI Driver should be installed to enable integrating Secrets Manager on your EKS pods. ASCP allows your secrets to be stored as files mounted inside the pods which can then be used by creating a SecretProviderClass YAML file that contains information about your secrets and how your workload should use them.



To limit access for your secrets to a specific Amazon EKS Pod you can utilize AWS IAM through IAM Roles and policies. The diagram below details an implementation example.

image::eks-secrets-manager.png[]

==== Installing Kubernetes Secrets Store CSI Driver


The commands on the snippet below add the repository for the CSI Driver on your machine, and from there you install the CSI Driver on your EKS Cluster using Helm

Using Helm command:
----
helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
helm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver --namespace kube-system --set syncSecret.enabled=true --set enableSecretRotation=true
----
using Terraform:

[source,hcl]
----

resource "helm_release" "secrets-store-csi-driver" {
  name       = "csi-secrets-store"
  repository = "https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts"
  chart      = "secrets-store-csi-driver"
  namespace  = "kube-system"
  version     = "1.4.5"

  set {
    name  = "installCRDs"
    value = "true"
  }
  set {
    name  = "syncSecret.enabled"
    value = "true"
  }
  set {
    name  = "enableSecretRotation"
    value = "true"
  }
  depends_on =  [ null_resource.kubectl ]
}

----




=== Setting up AWS Secrets and Configuration Provider (ASCP) on EKS

To install ASCP, use this command:

----
kubectl apply -f

https://raw.githubusercontent.com/aws/secrets-store-csi-driver-provider-aws/main/deployment/aws-provider-installer.yaml
----

Using Helm :

----
helm repo add aws-secrets-manager https://aws.github.io/secrets-store-csi-driver-provider-aws
helm install -n kube-system secrets-provider-aws aws-secrets-manager/secrets-store-csi-driver-provider-aws
----

using terraform helm provider:

----
resource "helm_release" "aws-secrets-manager" {
  name       = "aws-secrets-provider"
  repository = "https://aws.github.io/secrets-store-csi-driver-provider-aws"
  chart      = "secrets-store-csi-driver-provider-aws"
  namespace  = "kube-system"
  version    = "0.3.9"

  depends_on = [ helm_release.secrets-store-csi-driver, null_resource.kubectl  ]
}
----
----
kubectl get po -n kube-system
----
image::kube-system.png[]


This will install the ASCP on your kube-system namespace and create the necessary permissions and resources to allow it to run.


=== Configuring the IAM Role and Policies

An IAM Role should be created to allow access to the AWS Secrets Manager from EKS. The IAM Role should be attached to a Kubernetes service account which we will set up later.

image::trustentites.png[]

When creating secrets, you have the option of encrypting secrets with KMS. If your secrets are encrypted with KMS, your policy must contain a statement that decrypts the secret value. Otherwise, you can have a simple policy with minimal permissions to get secrets from Secrets Manager.

==== Policy for unencrypted secrets


image::role_sm.png[]


==== Creating a service account on your EKS Cluster

Create a Kubernetes service account so your pods can access Secret Manager. The IAM Role created previously will be attached to this service account to allow access.

image::serviceaccount.png[]

=== Creating SecretProviderClass

To enable using the Secrets Store CSI driver, create a custom resource named SecretProviderClass (SPC) on your EKS Cluster – which will provide driver configurations and provider-specific parameters to the CSI Driver. You configure all the secrets your pod needs through the SecretProviderClass. The pod will mount the secrets as a volume from the SPC



The secretObjects value above helps to implement the secret sync with Kubernetes Secrets. That means it will sync changes to your secrets on Secrets Manager with the existing configuration on the pod. It only works when secret sync is enabled.

image::secretproviderclass.png[]

The objects field of the SecretProviderClass can contain multiple subfields, which can be found here. You can define specific key-value pairs to extract from JSON-formatted secrets using the jmesPath. The objectName and the objectType fields are both required. Using the example below, you can mount multiple secrets on the custom resource.



=== Mounting secrets on deployment

All that’s left now is to mount your secrets when deploying your application to Kubernetes. The SecretProviderClass above will contain information about the secrets that are setup and how to display them in the EKS pod. This allows us to mount the secrets as volumes to the deployment manifest. The values from secrets will be extended as files on the mounted volumes, which the deployment manifest can reference.

The following is a sample deployment YAML file that deploys an nginx server on Kubernetes with health checks and rolling updates. Here, we add our secrets as a mounted volume on it and reference the SecretProviderClass created before.


// image::cluster role.png[]
image::deploymenet.png[]

Applying the changes from your deployment manifest allows your Kubernetes deployment to securely extract and use secrets from AWS Secrets Manager.




// image::nodegroup.png[]



// image::ssm.drawio.png[]




=== Overall view in one picture
image::ssm.overview.png[]


=== Best practices for EKS Secrets Manager integrations

According to the Shared Responsibility Model by AWS, as secure as AWS Secrets Manager is, there are implementations users can follow to strengthen its security further. Following these best practices can help you improve infrastructure security:

  -  Encrypt secrets using KMS
  -  Ensure that AWS Secrets Manager enforces data-at-rest encryption using KMS Customer Managed Keys (CMK)
  -  Enable secrets rotation and rotation interval according to your compliance policies
  -  Define minimal access policies to access secrets
